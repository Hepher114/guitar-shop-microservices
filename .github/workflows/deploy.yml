name: GuitarShop CI/CD â€” Build & Deploy to EKS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION:      us-east-1
  ECR_REGISTRY:    ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER:     guitarshop-eks
  K8S_NAMESPACE:   guitarshop

jobs:

  # â”€â”€â”€ Build & Push all service images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:
    name: Build & Push â†’ ECR
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      matrix:
        service: [catalog, cart, checkout, orders, ui]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag & push ${{ matrix.service }}
        env:
          IMAGE_TAG: ${{ github.sha }}
          SERVICE:   ${{ matrix.service }}
        run: |
          IMAGE_URI=$ECR_REGISTRY/guitarshop-$SERVICE

          echo "ğŸ³ Building $SERVICE..."
          docker build \
            -t $IMAGE_URI:$IMAGE_TAG \
            -t $IMAGE_URI:latest \
            ./services/$SERVICE

          echo "ğŸ“¤ Pushing $SERVICE â†’ ECR..."
          docker push $IMAGE_URI:$IMAGE_TAG
          docker push $IMAGE_URI:latest

          echo "image=$IMAGE_URI:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # â”€â”€â”€ Deploy to EKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy â†’ EKS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER

      - name: Apply K8s namespace
        run: kubectl apply -f infrastructure/k8s/namespace/namespace.yaml

      - name: Apply infrastructure (databases, messaging)
        run: |
          kubectl apply -f infrastructure/k8s/messaging/rabbitmq.yaml
          kubectl apply -f infrastructure/k8s/catalog/catalog.yaml
          kubectl apply -f infrastructure/k8s/cart/cart.yaml
          kubectl apply -f infrastructure/k8s/checkout/checkout.yaml
          kubectl apply -f infrastructure/k8s/orders/orders.yaml
          kubectl apply -f infrastructure/k8s/ui/ui.yaml
          kubectl apply -f infrastructure/k8s/ingress/ingress.yaml

      - name: Update image tags for all services
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          for SERVICE in catalog cart checkout orders ui; do
            echo "ğŸ”„ Updating $SERVICE â†’ $IMAGE_TAG"
            kubectl set image deployment/$SERVICE \
              $SERVICE=$ECR_REGISTRY/guitarshop-$SERVICE:$IMAGE_TAG \
              -n $K8S_NAMESPACE
          done

      - name: Wait for rollouts
        run: |
          for SERVICE in catalog cart checkout orders ui; do
            echo "â³ Waiting for $SERVICE rollout..."
            kubectl rollout status deployment/$SERVICE \
              -n $K8S_NAMESPACE \
              --timeout=300s
          done

      - name: Verify all pods are running
        run: |
          echo "ğŸ“Š Pod status:"
          kubectl get pods -n $K8S_NAMESPACE
          echo ""
          echo "ğŸŒ Services:"
          kubectl get svc -n $K8S_NAMESPACE
          echo ""
          echo "ğŸ”€ Ingress:"
          kubectl get ingress -n $K8S_NAMESPACE

      - name: Post deployment summary
        run: |
          INGRESS_URL=$(kubectl get ingress guitarshop-ingress \
            -n $K8S_NAMESPACE \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "âœ… GuitarShop deployed successfully!"
          echo "ğŸŒ URL: http://$INGRESS_URL"
